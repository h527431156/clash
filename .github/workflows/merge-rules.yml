name: Merge Clash INI

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  merge-ini:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v3

      - name: ä¸‹è½½åŸå§‹ Clash INI æ–‡ä»¶
        run: |
          curl -L "https://raw.githubusercontent.com/liandu2024/clash/refs/heads/main/proxy/clash-all-other.ini" -o original.ini

      - name: æ’å…¥ add.ini åˆ°æœ€åä¸€ä¸ªå›½å¤–å’Œç¬¬ä¸€ä¸ªå›½å†…è§„åˆ™ä¹‹é—´
        run: |
          mapfile -t lines < original.ini

          last_abroad=-1
          first_domestic=-1

          for i in "${!lines[@]}"; do
            if [[ "${lines[$i]}" =~ ruleset=ğŸŒ\ å›½å¤– ]]; then
              last_abroad=$i
            elif [[ "${lines[$i]}" =~ ruleset=â¡ï¸\ å›½å†… ]] && [[ $first_domestic -eq -1 ]]; then
              first_domestic=$i
            fi
          done

          if [[ $last_abroad -eq -1 || $first_domestic -eq -1 || $first_domestic -le $last_abroad ]]; then
            echo "æœªæ‰¾åˆ°æœ‰æ•ˆæ’å…¥ç‚¹ï¼Œä¿ç•™åŸæ–‡ä»¶"
            cp original.ini rules/clash-all-other.ini
          else
            {
              for ((i=0; i<=last_abroad; i++)); do
                echo "${lines[$i]}"
              done
              echo ""
              cat add-file/add.ini
              echo ""
              for ((i=last_abroad+1; i<${#lines[@]}; i++)); do
                echo "${lines[$i]}"
              done
            } > rules/clash-all-other.ini
          fi

      - name: æäº¤å¹¶æ¨é€å˜æ›´
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'actions@github.com'
          git add rules/clash-all-other.ini
          git commit -m "è‡ªåŠ¨åˆå¹¶ Clash è§„åˆ™æ–‡ä»¶" || echo "æ— æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          git push
